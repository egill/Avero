{
  "editable": true,
  "id": 2,
  "panels": [
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "P40AE60E18F02DE32"
      },
      "fieldConfig": {
        "defaults": {
          "decimals": 1,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 50
              },
              {
                "color": "red",
                "value": 70
              }
            ]
          },
          "unit": "celsius"
        }
      },
      "gridPos": {
        "h": 4,
        "w": 6,
        "x": 0,
        "y": 0
      },
      "id": 1,
      "targets": [
        {
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "P40AE60E18F02DE32"
          },
          "format": "table",
          "rawSql": "SELECT (data->>'cpu_temp_celsius')::float as value FROM events WHERE event_type = 'system.metrics' AND site LIKE 'AP-%' ORDER BY time DESC LIMIT 1",
          "refId": "A"
        }
      ],
      "title": "CPU Temperature",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "P40AE60E18F02DE32"
      },
      "fieldConfig": {
        "defaults": {
          "decimals": 1,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 70
              },
              {
                "color": "red",
                "value": 90
              }
            ]
          },
          "unit": "percent"
        }
      },
      "gridPos": {
        "h": 4,
        "w": 6,
        "x": 6,
        "y": 0
      },
      "id": 2,
      "targets": [
        {
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "P40AE60E18F02DE32"
          },
          "format": "table",
          "rawSql": "SELECT (data->>'mem_used_percent')::float as value FROM events WHERE event_type = 'system.metrics' AND site LIKE 'AP-%' ORDER BY time DESC LIMIT 1",
          "refId": "A"
        }
      ],
      "title": "Memory Usage",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "P40AE60E18F02DE32"
      },
      "fieldConfig": {
        "defaults": {
          "decimals": 2,
          "unit": "none"
        }
      },
      "gridPos": {
        "h": 4,
        "w": 6,
        "x": 12,
        "y": 0
      },
      "id": 3,
      "targets": [
        {
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "P40AE60E18F02DE32"
          },
          "format": "table",
          "rawSql": "SELECT (data->>'bus_events_per_second')::float as value FROM events WHERE event_type = 'system.metrics' AND site LIKE 'AP-%' ORDER BY time DESC LIMIT 1",
          "refId": "A"
        }
      ],
      "title": "Events/sec",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "P40AE60E18F02DE32"
      },
      "fieldConfig": {
        "defaults": {
          "decimals": 1,
          "unit": "none"
        }
      },
      "gridPos": {
        "h": 4,
        "w": 6,
        "x": 18,
        "y": 0
      },
      "id": 4,
      "targets": [
        {
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "P40AE60E18F02DE32"
          },
          "format": "table",
          "rawSql": "SELECT ((data->>'uptime_seconds')::float / 86400)::numeric(10,1) as value FROM events WHERE event_type = 'system.metrics' AND site LIKE 'AP-%' ORDER BY time DESC LIMIT 1",
          "refId": "A"
        }
      ],
      "title": "Uptime (days)",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "P40AE60E18F02DE32"
      },
      "description": "CLOSED (0) -> OPENING (1) -> OPEN (2) -> CLOSING (3)",
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "line",
            "fillOpacity": 30,
            "lineWidth": 2,
            "pointSize": 5,
            "showPoints": "always",
            "staircase": true
          },
          "mappings": [
            {
              "options": {
                "0": {
                  "color": "green",
                  "text": "CLOSED"
                }
              },
              "type": "value"
            },
            {
              "options": {
                "1": {
                  "color": "yellow",
                  "text": "OPENING"
                }
              },
              "type": "value"
            },
            {
              "options": {
                "2": {
                  "color": "red",
                  "text": "OPEN"
                }
              },
              "type": "value"
            },
            {
              "options": {
                "3": {
                  "color": "orange",
                  "text": "CLOSING"
                }
              },
              "type": "value"
            }
          ],
          "max": 3,
          "min": 0
        }
      },
      "gridPos": {
        "h": 8,
        "w": 24,
        "x": 0,
        "y": 4
      },
      "id": 5,
      "targets": [
        {
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "P40AE60E18F02DE32"
          },
          "format": "time_series",
          "rawSql": "SELECT time, site || ' Gate ' || COALESCE(data->>'gate_id', '1') as metric, CASE data->>'to_status' WHEN 'CLOSED' THEN 0 WHEN 'OPENING' THEN 1 WHEN 'OPEN' THEN 2 WHEN 'CLOSING' THEN 3 ELSE 0 END as value FROM events WHERE data->>'type' = 'gate.status_changed' AND time > NOW() - INTERVAL '6 hours' ORDER BY time",
          "refId": "A"
        }
      ],
      "title": "Gate State Timeline",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "P40AE60E18F02DE32"
      },
      "gridPos": {
        "h": 8,
        "w": 24,
        "x": 0,
        "y": 12
      },
      "id": 6,
      "targets": [
        {
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "P40AE60E18F02DE32"
          },
          "format": "table",
          "rawSql": "SELECT time, site, data->>'type' as event, data->>'gate_id' as gate, data->>'from_status' as from_state, data->>'to_status' as to_state FROM events WHERE event_type = 'gates' AND time > NOW() - INTERVAL '1 hour' ORDER BY time DESC LIMIT 50",
          "refId": "A"
        }
      ],
      "title": "Gate Events (Live)",
      "type": "table"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "P40AE60E18F02DE32"
      },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "bars",
            "fillOpacity": 80
          },
          "decimals": 0,
          "unit": "none"
        }
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 20
      },
      "id": 7,
      "targets": [
        {
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "P40AE60E18F02DE32"
          },
          "format": "time_series",
          "rawSql": "SELECT time_bucket('1 minute', time) as time, COUNT(*) FILTER (WHERE data->>'to_status' = 'OPEN') as opens FROM events WHERE data->>'type' = 'gate.status_changed' AND time > NOW() - INTERVAL '1 hour' GROUP BY 1 ORDER BY 1",
          "refId": "A"
        }
      ],
      "title": "Gate Cycles per Minute",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "P40AE60E18F02DE32"
      },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "line",
            "fillOpacity": 10,
            "lineWidth": 2
          },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 50
              },
              {
                "color": "red",
                "value": 70
              }
            ]
          },
          "unit": "celsius"
        }
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 20
      },
      "id": 8,
      "targets": [
        {
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "P40AE60E18F02DE32"
          },
          "format": "time_series",
          "rawSql": "SELECT time, site as metric, (data->>'cpu_temp_celsius')::float as value FROM events WHERE event_type = 'system.metrics' AND site LIKE 'AP-%' AND time > NOW() - INTERVAL '2 hours' ORDER BY time",
          "refId": "A"
        }
      ],
      "title": "CPU Temperature History",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "P40AE60E18F02DE32"
      },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "line",
            "fillOpacity": 10,
            "lineWidth": 2
          },
          "unit": "us"
        }
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 28
      },
      "id": 9,
      "targets": [
        {
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "P40AE60E18F02DE32"
          },
          "format": "time_series",
          "rawSql": "SELECT time, site as metric, (data->>'bus_avg_latency_us')::float as value FROM events WHERE event_type = 'system.metrics' AND site LIKE 'AP-%' AND time > NOW() - INTERVAL '2 hours' ORDER BY time",
          "refId": "A"
        }
      ],
      "title": "Event Bus Latency",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "P40AE60E18F02DE32"
      },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "line",
            "fillOpacity": 20,
            "lineWidth": 2
          },
          "unit": "none"
        }
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 28
      },
      "id": 10,
      "targets": [
        {
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "P40AE60E18F02DE32"
          },
          "format": "time_series",
          "rawSql": "SELECT time, site as metric, (data->>'bus_events_per_second')::float as value FROM events WHERE event_type = 'system.metrics' AND site LIKE 'AP-%' AND time > NOW() - INTERVAL '2 hours' ORDER BY time",
          "refId": "A"
        }
      ],
      "title": "Events per Second",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "P40AE60E18F02DE32"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "none"
        }
      },
      "gridPos": {
        "h": 4,
        "w": 8,
        "x": 0,
        "y": 36
      },
      "id": 11,
      "targets": [
        {
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "P40AE60E18F02DE32"
          },
          "format": "table",
          "rawSql": "SELECT COUNT(*) as value FROM events WHERE time > NOW() - INTERVAL '1 hour'",
          "refId": "A"
        }
      ],
      "title": "Total Events",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "P40AE60E18F02DE32"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          }
        }
      },
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 8,
        "y": 36
      },
      "id": 12,
      "options": {
        "orientation": "horizontal",
        "showValue": "always",
        "xField": "Event Type"
      },
      "targets": [
        {
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "P40AE60E18F02DE32"
          },
          "format": "table",
          "rawSql": "SELECT event_type as \"Event Type\", COUNT(*)::bigint as \"Count\" FROM events WHERE time > NOW() - INTERVAL '1 hour' GROUP BY event_type ORDER BY \"Count\" DESC LIMIT 10",
          "refId": "A"
        }
      ],
      "title": "Events by Type (1h)",
      "type": "barchart"
    },
    {
      "datasource": {
        "type": "grafana-postgresql-datasource",
        "uid": "P40AE60E18F02DE32"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          }
        }
      },
      "gridPos": {
        "h": 8,
        "w": 8,
        "x": 16,
        "y": 36
      },
      "id": 13,
      "options": {
        "orientation": "horizontal",
        "showValue": "always",
        "xField": "Site"
      },
      "targets": [
        {
          "datasource": {
            "type": "grafana-postgresql-datasource",
            "uid": "P40AE60E18F02DE32"
          },
          "format": "table",
          "rawSql": "SELECT site as \"Site\", COUNT(*)::bigint as \"Count\" FROM events WHERE time > NOW() - INTERVAL '1 hour' GROUP BY site ORDER BY \"Count\" DESC",
          "refId": "A"
        }
      ],
      "title": "Events by Site (1h)",
      "type": "barchart"
    }
  ],
  "refresh": "10s",
  "schemaVersion": 37,
  "tags": [
    "avero",
    "gates",
    "timescaledb"
  ],
  "timezone": "browser",
  "title": "Gate Status (Real-time)",
  "uid": "gates-realtime",
  "version": 2
}
