# Ralph Progress Log - Code Quality & Performance
Started: 2026-01-07

## Codebase Patterns

### Architecture
- Async runtime: Tokio
- Domain types: src/domain/ (types.rs, journey.rs)
- Services: src/services/ (tracker is central orchestrator)
- I/O adapters: src/io/ (mqtt, rs485, cloudplus, egress, prometheus)
- Infrastructure: src/infra/ (config, metrics, broker)

### Testing
- Primary tests: src/services/tracker/tests.rs
- Test helpers: create_test_tracker(), create_event()
- All tests use #[tokio::test]
- Run: cargo test

### Conventions
- Metrics use AtomicU64 for lock-free counters
- HashMaps keyed by track_id (i64) or geometry_id (i32)
- JourneyEvent uses builder pattern with_type().with_zone()
- Config via TOML in config/ directory

### Dependencies Already Available
- serde, serde_json (serialization)
- tokio (async runtime)
- tracing (logging)
- clap (CLI parsing - not yet used)

### Gotchas
- Mutex in metrics.rs uses std::sync::Mutex (can poison)
- cargo clippy -- -D warnings now passes clean
- Cross-compile target: aarch64-unknown-linux-gnu (RPi5)
- Unused fields prefixed with underscore to suppress dead_code warnings

## Key Files
- Cargo.toml (dependencies, profiles)
- src/main.rs (entry point)
- src/domain/types.rs (ParsedEvent, Person, EventType)
- src/domain/journey.rs (Journey, JourneyEvent, JourneyOutcome)
- src/infra/metrics.rs (Metrics struct)
- src/services/tracker/mod.rs (Tracker - main orchestrator)

---

## 2026-01-07 - US-001 - Add rust-toolchain.toml to pin Rust version
- Files changed: rust-toolchain.toml (new), CLAUDE.md
- **Learnings:** rust-toolchain.toml uses [toolchain] section with channel key. 108 tests currently pass. 28 clippy warnings exist (addressed by US-002).
---

## 2026-01-07 - US-002 - Fix all clippy warnings
- Files changed: src/bin/gate_test.rs, src/bin/tui.rs, src/domain/mod.rs, src/infra/config.rs, src/infra/metrics.rs, src/io/cloudplus.rs, src/io/mod.rs, src/io/rs485.rs, src/services/acc_collector.rs, src/services/door_correlator.rs, src/services/journey_manager.rs, src/services/mod.rs, src/services/stitcher.rs, src/services/tracker/handlers.rs, src/services/tracker/mod.rs
- **Learnings:**
  - Use `std::array::from_fn(|_| AtomicU64::new(0))` instead of const with interior mutability
  - Prefix unused struct fields with underscore (e.g., `_field: Type`) to suppress dead_code warnings
  - For serde deserialization of ignored fields, use `#[serde(default, rename = "field_name")]` with underscore-prefixed field
  - Combine duplicate if branches with `||` operator
  - `cargo clippy --fix` auto-fixes: useless format!, option_as_ref_deref, bind_instead_of_map, println_empty_string, unused imports
  - #[allow(dead_code)] is acceptable for public API methods not yet used
  - #[allow(clippy::too_many_arguments)] acceptable for internal functions when refactoring is impractical
---
