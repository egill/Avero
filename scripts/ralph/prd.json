{
  "branchName": "gateway/analysis-logger",
  "userStories": [
    {
      "id": "GA-001",
      "title": "Create gateway-analysis binary with config + CLI",
      "category": "diagnostics",
      "acceptanceCriteria": [
        "New binary `gateway-analysis` builds and runs",
        "Supports --config, --log-dir, --topics, --rotation, --site-id",
        "Defaults align with existing config (MQTT host, ACC port, RS485 device)",
        "Help text documents all flags"
      ],
      "instructions": "Add src/bin/gateway_analysis.rs with CLI parsing. Reuse Config where possible and add analysis-specific defaults for log dir/rotation.",
      "files": [
        "Cargo.toml",
        "src/bin/gateway_analysis.rs",
        "src/infra/config.rs"
      ],
      "priority": 0,
      "passes": true,
      "notes": "Single binary preferred for correlation and simpler ops."
    },
    {
      "id": "GA-001a",
      "title": "Run Mosquitto broker with auth for test capture",
      "category": "diagnostics",
      "acceptanceCriteria": [
        "Mosquitto runs as the broker for the test window",
        "Username/password auth enabled (user: avero, pass: avero)",
        "Publishers can connect and publish successfully",
        "Broker logs stored to file for backup"
      ],
      "instructions": "Create a Mosquitto config for the test run (listener, allow_anonymous false, password file). Document commands to start/stop and verify connectivity.",
      "files": [
        "docs/gateway-analysis.md",
        "config/mosquitto.conf (new)",
        "config/mosquitto.passwd (new)"
      ],
      "priority": 0,
      "passes": true,
      "notes": "Broker replaces gateway broker during test."
    },
    {
      "id": "GA-002",
      "title": "MQTT topic logging to per-topic JSONL files",
      "category": "logging",
      "acceptanceCriteria": [
        "Subscribes to configured MQTT topics (events, tracks, acc, gate, journeys, metrics)",
        "Writes JSONL per topic: logs/mqtt/<topic>-YYYYMMDD.jsonl",
        "Each record includes ts_recv, topic, payload_raw, and parsed fields",
        "Logging continues when a payload is malformed"
      ],
      "instructions": "Reuse existing MQTT client; on message, write a JSONL record with receive timestamp and raw payload. Keep parsing best-effort.",
      "files": [
        "src/bin/gateway_analysis.rs",
        "src/io/mqtt.rs",
        "src/io/analysis_logger.rs"
      ],
      "priority": 0,
      "passes": false,
      "notes": "Must include gateway/tracks for delete/lost/stitch."
    },
    {
      "id": "GA-003",
      "title": "ACC TCP logging to dedicated JSONL",
      "category": "logging",
      "acceptanceCriteria": [
        "Listens on ACC port (default 25803)",
        "Logs raw line + parsed fields to logs/acc/acc-YYYYMMDD.jsonl",
        "Records kiosk_ip, receipt_id (if present), and pos mapping (if known)",
        "Config option to split per kiosk file is available"
      ],
      "instructions": "Reuse ACC listener; log on receive with raw line and parsed fields. Default to a single file; optional per-kiosk split via CLI/config.",
      "files": [
        "src/bin/gateway_analysis.rs",
        "src/io/acc_listener.rs",
        "src/io/analysis_logger.rs"
      ],
      "priority": 0,
      "passes": false,
      "notes": "Key for validating ACC mapping and timing."
    },
    {
      "id": "GA-004",
      "title": "RS485 logging to dedicated JSONL",
      "category": "logging",
      "acceptanceCriteria": [
        "RS485 monitor runs in analysis binary",
        "Logs raw frame + parsed door state to logs/rs485/rs485-YYYYMMDD.jsonl",
        "Includes ts_recv and decoded fields"
      ],
      "instructions": "Reuse RS485 monitor code; emit JSONL per frame and per parsed state.",
      "files": [
        "src/bin/gateway_analysis.rs",
        "src/io/rs485.rs",
        "src/io/analysis_logger.rs"
      ],
      "priority": 1,
      "passes": false,
      "notes": "Required for gate timing correlation."
    },
    {
      "id": "GA-005",
      "title": "Unified JSONL schema + log writer with rotation",
      "category": "logging",
      "acceptanceCriteria": [
        "All logs use a consistent schema (ts_recv, ts_event, src, site, payload_raw, fields)",
        "Daily rotation is default; optional size-based rotation available",
        "Writing is non-blocking (buffered writer or channel)",
        "Logging continues on IO errors with warnings"
      ],
      "instructions": "Create analysis_logger module to handle file routing and rotation. Ensure per-topic file paths are deterministic.",
      "files": [
        "src/io/analysis_logger.rs",
        "src/bin/gateway_analysis.rs"
      ],
      "priority": 1,
      "passes": false,
      "notes": "Rotation prevents runaway disk usage."
    },
    {
      "id": "GA-006",
      "title": "Add periodic summary stats for data-gap detection",
      "category": "diagnostics",
      "acceptanceCriteria": [
        "Writes 1-min summary rows to logs/summary/summary-YYYYMMDD.jsonl",
        "Tracks counts: zone_entry/exit, track_create/delete/lost, acc received/matched",
        "Highlights imbalances (e.g., entries without exits)",
        "Summary includes time bucket and site"
      ],
      "instructions": "Maintain counters in memory; flush once per minute.",
      "files": [
        "src/bin/gateway_analysis.rs",
        "src/io/analysis_logger.rs"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Quick sanity checks without offline analysis."
    },
    {
      "id": "GA-007",
      "title": "Add runbook + sample analysis queries",
      "category": "docs",
      "acceptanceCriteria": [
        "Docs explain how to run the binary and where logs go",
        "Includes example jq/rg commands to inspect ACC matching gaps",
        "Explains how to correlate ACC, tracks, and POS sessions"
      ],
      "instructions": "Document minimal operational steps and example analysis commands.",
      "files": [
        "docs/gateway-analysis.md"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Keeps future investigations repeatable."
    },
    {
      "id": "GA-008",
      "title": "Add smoke tests for RS485, Xovis MQTT, and ACC logging",
      "category": "diagnostics",
      "acceptanceCriteria": [
        "Runbook includes a 60s smoke test for RS485 on /dev/ttyAMA4 @ 19200 baud",
        "Runbook includes MQTT/Xovis smoke test (receive at least one message on gateway/events or gateway/tracks)",
        "Runbook includes ACC smoke test (receive at least one ACC line)",
        "Failures are clearly indicated with next-step guidance"
      ],
      "instructions": "Document quick smoke-test steps and expected outputs, including where to check the JSONL logs for each stream.",
      "files": [
        "docs/gateway-analysis.md"
      ],
      "priority": 1,
      "passes": false,
      "notes": "Ensures we validate data capture before long runs."
    }
  ]
}
